# name: Build and Release

# on:
#   push:
#     tags:
#       - "v*.*.*"
#   workflow_dispatch:

# permissions:
#   contents: write

# jobs:
#   build:
#     name: Build Binaries
#     runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         include:
#           - os: linux
#             arch: amd64
#           - os: linux
#             arch: arm64
#           - os: linux
#             arch: arm
#           - os: darwin
#             arch: amd64
#           - os: darwin
#             arch: arm64
#           - os: windows
#             arch: amd64

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Go
#         uses: actions/setup-go@v5
#         with:
#           go-version: "1.22"

#       - name: Get version
#         id: version
#         run: |
#           if [[ "${{ github.ref }}" == refs/tags/* ]]; then
#             VERSION=${GITHUB_REF#refs/tags/}
#           else
#             VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
#           fi
#           echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
#           echo "COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
#           echo "DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

#       - name: Build binary
#         env:
#           GOOS: ${{ matrix.os }}
#           GOARCH: ${{ matrix.arch }}
#           CGO_ENABLED: 0
#         run: |
#           BINARY_NAME="observex-agent-${{ matrix.os }}-${{ matrix.arch }}"
#           if [ "${{ matrix.os }}" = "windows" ]; then
#             BINARY_NAME="${BINARY_NAME}.exe"
#           fi

#           go build \
#             -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }} -X main.commit=${{ steps.version.outputs.COMMIT }} -X main.date=${{ steps.version.outputs.DATE }}" \
#             -o "${BINARY_NAME}" \
#             main.go

#           # Create checksum
#           sha256sum "${BINARY_NAME}" > "${BINARY_NAME}.sha256"

#       - name: Upload artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: observex-agent-${{ matrix.os }}-${{ matrix.arch }}
#           path: |
#             observex-agent-*
#             !observex-agent-*.sha256

#       - name: Upload checksums
#         uses: actions/upload-artifact@v4
#         with:
#           name: checksums-${{ matrix.os }}-${{ matrix.arch }}
#           path: observex-agent-*.sha256

#   release:
#     name: Create Release
#     needs: build
#     runs-on: ubuntu-latest
#     if: startsWith(github.ref, 'refs/tags/')

#     steps:
#       - name: Download all artifacts
#         uses: actions/download-artifact@v4
#         with:
#           path: artifacts

#       - name: Prepare release assets
#         run: |
#           mkdir -p release
#           find artifacts -type f -name "observex-agent-*" -exec cp {} release/ \;
#           cd release
#           ls -lah

#       - name: Create Release
#         uses: softprops/action-gh-release@v1
#         with:
#           files: release/*
#           generate_release_notes: true
#           draft: false
#           prerelease: false
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#   container:
#     name: Build & Push Docker Image
#     needs: build
#     runs-on: ubuntu-latest
#     if: startsWith(github.ref, 'refs/tags/')

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Get version
#         id: version
#         run: |
#           VERSION=${GITHUB_REF#refs/tags/}
#           echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
#           echo "COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
#           echo "DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

#       - name: Login to GHCR
#         uses: docker/login-action@v3
#         with:
#           registry: ghcr.io
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}

#       - name: Build Docker Image
#         run: |
#           IMAGE=ghcr.io/${{ github.repository }}
#           VERSION=${{ steps.version.outputs.VERSION }}
#           COMMIT=${{ steps.version.outputs.COMMIT }}
#           DATE=${{ steps.version.outputs.DATE }}

#           docker build \
#             --build-arg VERSION=$VERSION \
#             --build-arg COMMIT=$COMMIT \
#             --build-arg DATE=$DATE \
#             -t $IMAGE:$VERSION \
#             -t $IMAGE:latest \
#             .

#       - name: Push Docker Image
#         run: |
#           IMAGE=ghcr.io/${{ github.repository }}
#           VERSION=${{ steps.version.outputs.VERSION }}
#           docker push $IMAGE:$VERSION
#           docker push $IMAGE:latest

name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Build for multiple platforms
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o observex-agent-linux-amd64 main.go
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o observex-agent-linux-arm64 main.go
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o observex-agent-darwin-amd64 main.go
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o observex-agent-darwin-arm64 main.go
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o observex-agent-windows-amd64.exe main.go

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: observex-agent-*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker
        run: |
          IMAGE=ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')
          VERSION=${{ steps.version.outputs.VERSION }}

          docker build -t $IMAGE:$VERSION -t $IMAGE:latest .
          docker push $IMAGE:$VERSION
          docker push $IMAGE:latest
